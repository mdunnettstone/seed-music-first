<%= form_tag(new_booking_path, method: :get) do %>
  <%= text_field_tag :start_date, @searched_start_time.strftime("%Y-%m-%d") %>
  <%= select_time @searched_start_time, minute_step: 15 %>
  <%= submit_tag "Search", class: "btn btn-primary" %>
<% end %>


<h3>Room timeslots</h3>
<div class = "row">
  <div class = "col-8">
    <% @room_timeslots.group_by(&:room).each do |room, timeslots| %>
      <div class = "col-10 offset-1 col-md-5 col-lg-3">
        <h4><%= room.name %></h4>
        <ul class = "slot-list">
          <% timeslots.each do |timeslot| %>
            <% if timeslot.booking_id.blank? %>
              <div class = "col-10 my-2 btn btn-primary selectable" id = <%= "#{timeslot.id}" %>><%= "#{timeslot.slot_start.strftime("%H:%M")} - available" %></div>
            <% else %>
              <div class = "col-10 my-2 btn btn-primary" disabled><%= "#{timeslot.slot_start.strftime("%H:%M")} - booked by #{timeslot.booking.user.email}" %></div>
            <% end %>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>
  <div class = "col-4">
    <div class = "col-8 offset-2">
      <h4>Your booking</h4>
      <div class="card">
        <ul class="list-group list-group-flush">
          <li class="list-group-item">Room: <span class = "bookingroom"></span></li>
          <li class="list-group-item">Date: <span class = "bookingdate"></span></li>
          <li class="list-group-item">Time: </li>
        </ul>
      </div>
      <%= link_to 'Continue', '#', class: "btn btn-primary my-2 col-12 update-test", id: current_user.id %>
    </div>
  </div>
</div>

<script>
$(function () {
  

  //Adds class of active when clicked
  $('.selectable').click(function(e) {
    $(e.target).toggleClass('active');
    var selected = $("ul.slot-list").find(".active");
    $.each(selected, function(index, object) {
      console.log(object.id);
    });
  });

  //Updates booking id of all selected roomTimeslots
  $('.update-test').click(function() {
    var userId = this.id;
    $.post("/bookings", {
      _method: "POST",
      booking: {
        user_id: userId
      }
    }).success(function(data) {
      var bookingId = data.id;
      var selected = $("ul.slot-list").find(".active");
      $.each(selected, function(index, object) {
        $.post("/room_timeslots/" + object.id, {
          _method: "PUT",
          room_timeslot: {
            booking_id: bookingId
          }
        });
      });
    });
  });
});
</script>